{% extends "base.html" %}

{% block title %}Lista de Tickets{% endblock %}

{% block content %}

<header>
    <h1>Lista de Tickets</h1>
    <nav>
        <a href="/logout">Cerrar sesiÃ³n</a>
        {% if current_user.role != 'usittel' %}
        <a href="{{ url_for('create_ticket') }}">Crear Ticket</a>
        {% endif %}
    </nav>
</header>

<main>
    <!-- Barra de BÃºsqueda -->
    <input type="text" id="searchInput" placeholder="Buscar tickets..." class="search-bar">

    <!-- Filtros -->
    <form action="/tickets" method="GET" style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <label for="estado">Estado:</label>
        <select name="estado" id="estado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en proceso">En proceso</option>
            <option value="cerrado">Cerrado</option>
        </select>

        <label for="prioridad">Prioridad:</label>
        <select name="prioridad" id="prioridad">
            <option value="">Todas</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
        </select>

        <button type="submit" class="btn-filter">Filtrar</button>
        <a href="{{ url_for('export_tickets') }}" class="btn btn-export">ðŸ“¥ Exportar CSV</a>

    </form>

    <table id="ticketsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tipo</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Usuario Creador</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in tickets %}
            <tr class="ticket-row">
                <td>{{ ticket.id }}</td>
                <td>{{ ticket.tipo }}</td>
                <td>{{ ticket.prioridad }}</td>
                <td class="estado">{{ ticket.estado }}</td>
                <td>{{ ticket.usuario_creador }}</td>
                <td>
                    <a href="{{ url_for('view_ticket', id=ticket.id) }}" class="btn btn-view">Ver</a>
                    {% if current_user.role == 'usittel' %}
                    <form action="/delete-ticket/{{ ticket.id }}" method="POST">
                        <button type="button" class="btn btn-delete confirm-delete">Eliminar</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p id="noResultsMessage" style="display: none; text-align: center; color: red; font-weight: bold;">No se encontraron tickets.</p>

</main>

<!-- Script de BÃºsqueda en Vivo -->
<script>
    document.getElementById("searchInput").addEventListener("keyup", function() {
        let input = this.value.toLowerCase();
        let rows = document.querySelectorAll("#ticketsTable tbody tr");
        let found = false;

        rows.forEach(row => {
            let text = row.textContent.toLowerCase();
            if (text.includes(input)) {
                row.style.display = "";
                found = true;
            } else {
                row.style.display = "none";
            }
        });

        document.getElementById("noResultsMessage").style.display = found ? "none" : "block";
    });
</script>

<script>
    function confirmarAccion(mensaje) {
        return confirm(mensaje);
    }

    function sortTable(columnIndex) {
        let table = document.getElementById("ticketsTable");
        let rows = Array.from(table.rows).slice(1);
        let isAscending = table.rows[0].cells[columnIndex].getAttribute("data-order") === "asc";

        rows.sort((rowA, rowB) => {
            let cellA = rowA.cells[columnIndex].textContent.trim().toLowerCase();
            let cellB = rowB.cells[columnIndex].textContent.trim().toLowerCase();
            return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });

        table.rows[0].cells[columnIndex].setAttribute("data-order", isAscending ? "desc" : "asc");

        rows.forEach(row => table.appendChild(row));
    }

    document.addEventListener("DOMContentLoaded", function () {
        let table = document.getElementById("ticketsTable");
        let rows = Array.from(table.getElementsByTagName("tbody")[0].rows);
        let rowsPerPage = 5;
        let currentPage = 1;

        function showPage(page) {
            let start = (page - 1) * rowsPerPage;
            let end = start + rowsPerPage;
            rows.forEach((row, index) => {
                row.style.display = index >= start && index < end ? "" : "none";
            });
            document.getElementById("pageNumber").textContent = `PÃ¡gina ${page}`;
        }

        function changePage(delta) {
            let totalPages = Math.ceil(rows.length / rowsPerPage);
            currentPage = Math.min(Math.max(1, currentPage + delta), totalPages);
            showPage(currentPage);
        }

        document.getElementById("prevPage").addEventListener("click", () => changePage(-1));
        document.getElementById("nextPage").addEventListener("click", () => changePage(1));

        showPage(currentPage);
    });
</script>

{% endblock %}
{% extends "base.html" %}

{% block title %}Lista de Tickets{% endblock %}

{% block content %}

<header class="header-container">
    <h1>Lista de Tickets</h1>
    <nav class="nav-links">
        <a href="/logout" class="btn-logout">Cerrar sesi√≥n</a>
        {% if current_user.role != 'usittel' %}
        <a href="{{ url_for('create_ticket') }}" class="btn-create">+ Crear Ticket</a>
        {% endif %}
    </nav>
</header>

<main class="main-container">
    <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="Buscar tickets..." class="search-bar">
        
        <select name="estado" id="estado">
            <option value="">Estado</option>
            <option value="pendiente">Pendiente</option>
            <option value="en proceso">En proceso</option>
            <option value="cerrado">Cerrado</option>
        </select>
    
        <select name="prioridad" id="prioridad">
            <option value="">Prioridad</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
        </select>
    
        <button type="submit" class="btn-filter">Filtrar</button>
        <a href="{{ url_for('export_tickets') }}" class="btn-export">üì• Exportar</a>
    </div>
    

    <table id="ticketsTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">ID ‚¨ç</th>
                <th onclick="sortTable(1)">Tipo ‚¨ç</th>
                <th onclick="sortTable(2)">Prioridad ‚¨ç</th>
                <th onclick="sortTable(3)">Estado ‚¨ç</th>
                <th onclick="sortTable(4)">Usuario Creador ‚¨ç</th>
                <th>Acciones</th>
            </tr>
        </thead>
        
        <tbody>
            {% for ticket in tickets %}
            <tr class="ticket-row">
                <td>{{ ticket.id }}</td>
                <td>{{ ticket.tipo }}</td>
                <td>{{ ticket.prioridad }}</td>
                <td class="estado">{{ ticket.estado }}</td>
                <td>{{ ticket.usuario_creador }}</td>
                <td class="actions-cell">
                    <a href="{{ url_for('view_ticket', id=ticket.id) }}" class="btn btn-view">üëÅ Ver</a>
                    {% if current_user.role == 'usittel' %}
                    <form action="/delete-ticket/{{ ticket.id }}" method="POST" class="delete-form">
                        <button type="button" class="btn btn-delete confirm-delete">üóë Eliminar</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p id="noResultsMessage" class="no-results">No se encontraron tickets.</p>
</main>

<!-- Script de B√∫squeda en Vivo -->
<script>
    document.getElementById("searchInput").addEventListener("keyup", function() {
        let input = this.value.toLowerCase();
        let rows = document.querySelectorAll("#ticketsTable tbody tr");
        let found = false;

        rows.forEach(row => {
            let text = row.textContent.toLowerCase();
            if (text.includes(input)) {
                row.style.display = "";
                found = true;
            } else {
                row.style.display = "none";
            }
        });

        document.getElementById("noResultsMessage").style.display = found ? "none" : "block";
    });
</script>
<script>
    function sortTable(columnIndex) {
        let table = document.getElementById("ticketsTable");
        let tbody = table.getElementsByTagName("tbody")[0];
        let rows = Array.from(tbody.getElementsByTagName("tr"));
        let isAscending = table.rows[0].cells[columnIndex].getAttribute("data-order") === "asc";

        rows.sort((rowA, rowB) => {
            let cellA = rowA.cells[columnIndex].textContent.trim().toLowerCase();
            let cellB = rowB.cells[columnIndex].textContent.trim().toLowerCase();
            return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });

        table.rows[0].cells[columnIndex].setAttribute("data-order", isAscending ? "desc" : "asc");

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
    }
</script>


{% endblock %}
